{% extends 'base.html' %}
{% block content %}

<!-- Welcome & Overall Progress -->
<div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4>Welcome back, {{ user.first_name }}!</h4>
        <p>You are currently enrolled in {{ enrollments.count }} course{{ enrollments.count|pluralize }}.</p>
    </div>
    <div style="width: 250px;">
        <div class="progress">
            <div class="progress-bar bg-success" role="progressbar" style="width: {{ overall_progress }}%;" aria-valuenow="{{ overall_progress }}" aria-valuemin="0" aria-valuemax="100">
                {{ overall_progress }}%
            </div>
        </div>
        <small class="text-muted">Overall Progress</small>
    </div>
</div>

<div class="row">
    <!-- Courses Section -->
    <div class="col-lg-8 col-md-12 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Your Courses</h4>
            <a href="{% url 'course_list' %}" class="btn btn-primary btn-sm">Browse More</a>
        </div>

        <div class="row g-4">
            {% for enrollment in enrollments %}
            <div class="col-md-6">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ enrollment.course.title }}</h5>
                        <p class="text-muted">{{ enrollment.course.description|truncatechars:100 }}</p>

                        <!-- Course Progress -->
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ enrollment.progress }}%;" aria-valuenow="{{ enrollment.progress }}" aria-valuemin="0" aria-valuemax="100">
                                {{ enrollment.progress }}%
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="mt-auto d-flex flex-wrap gap-2">
                            <a href="{% url 'course_detail' course_id=enrollment.course.id %}" class="btn btn-primary btn-sm flex-fill">Continue Course</a>
                            <a href="{% url 'forum_view' enrollment.course.id %}" class="btn btn-outline-secondary btn-sm flex-fill">Forum</a>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
                <p>You haven't enrolled in any courses yet. <a href="{% url 'course_list' %}">Browse courses</a> to get started!</p>
            {% endfor %}
        </div>
    </div>

    <!-- Sidebar: Certificates & Upcoming Deadlines -->
    <div class="col-lg-4 col-md-12">
        <!-- Certificates -->
        <h4>My Certificates</h4>
        <div class="row g-3 mb-4">
            {% for cert in certificates %}
            <div class="col-12">
                <div class="card border-success shadow-sm">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ cert.course.title }}</h6>
                            <small class="text-muted">Issued: {{ cert.issued_at|date:"F j, Y" }}</small>
                        </div>
                        <a href="#" class="btn btn-outline-success btn-sm">Download PDF</a>
                    </div>
                </div>
            </div>
            {% empty %}
                <p class="text-muted">No certificates earned yet.</p>
            {% endfor %}
        </div>

        <!-- Upcoming Deadlines -->
        <h4>Upcoming Deadlines</h4>
        <ul class="list-group mb-4">
            {% for item in upcoming_deadlines %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ item.title }}</strong>
                    <br>
                    <small class="text-muted">Due: {{ item.due_date|date:"M d, Y H:i" }}</small>
                </div>
                <a href="{% url 'course_detail' course_id=item.course.id %}" class="btn btn-outline-primary btn-sm">Go</a>
            </li>
            {% empty %}
                <li class="list-group-item text-muted">No upcoming assignments or quizzes.</li>
            {% endfor %}
        </ul>

        <!-- Recent Forum Activity -->
        <h4 class="mt-4">Recent Forum Posts</h4>
        <ul class="list-group mb-4">
            {% for post in recent_forum_posts %}
                <li class="list-group-item">
                    <strong>{{ post.forum.course.title }}</strong> - {{ post.user.username }}
                    <br>
                    <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                    <p>{{ post.content|truncatechars:50 }}</p>
                </li>
            {% empty %}
                <li class="list-group-item text-muted">No recent posts.</li>
            {% endfor %}
        </ul>

    </div>
</div>
{% endblock %}
